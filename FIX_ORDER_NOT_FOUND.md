# Исправление ошибки "Заказ не найден"

## Проблемы, которые были исправлены

1. ✅ Водитель жмет старые кнопки из предыдущего заказа
2. ✅ После рестарта state/кеш очистился, а хэндлер ищет заказ не по order_id
3. ✅ Заказ уже перешёл в finished/expired/cancelled, а хэндлер всё ещё пытается его найти

## Что было сделано

### 1. Новый формат callback-data
Все кнопки водителя теперь используют формат `trip:action:order_id`:
- `trip:arrived:123` - водитель подъехал
- `trip:waiting:123` - водитель ждет клиента
- `trip:start:123` - поездка началась
- `trip:finish:123` - поездка завершена
- `trip:cancel:123` - отмена поездки

### 2. Валидация заказа
Добавлена функция `validate_driver_order_access()`, которая проверяет:
- Заказ существует
- Водитель имеет права доступа (assigned_driver_id или reserved_driver_id)
- Статус заказа в допустимом множестве для перехода

Если проверка не проходит → показывается мягкое сообщение:
"⚠️ Заказ уже закрыт или переназначен. Обновите панель задач: /my_orders"

### 3. Функция получения активного заказа
Добавлена `get_active_driver_order()`:
- Ищет заказ по `assigned_driver_id` и статусам `accepted`, `arrived`, `onboard`
- Используется в "Я на линии" и "Мои заказы"

### 4. Идемпотентность переходов
Все методы `set_arrived()`, `set_started()`, `set_finished()` теперь идемпотентны:
- Если заказ уже в нужном статусе → просто возвращают OK без ошибки
- Защита от дублей и повторных нажатий

### 5. Новое сообщение при принятии заказа
После принятия заказа:
- Старое сообщение редактируется (убираются кнопки принятия)
- Отправляется НОВОЕ сообщение с актуальными кнопками `driver_after_accept()`
- Водитель всегда видит актуальное состояние

### 6. Команда /my_orders
Добавлена команда `/my_orders` для обновления панели задач:
- Показывает активный заказ с актуальными кнопками
- Если нет активного заказа → показывает историю

## Как это работает теперь

1. **Водитель принимает заказ:**
   - Старое сообщение редактируется
   - Отправляется новое сообщение с кнопками "Подъехал", "Жду клиента", "Отменить"
   - Callback: `trip:arrived:123`, `trip:waiting:123`, `trip:cancel:123`

2. **Водитель нажимает "Подъехал":**
   - Проверяется: заказ существует, права доступа, статус = `accepted`
   - Если уже `arrived` → просто OK (идемпотентность)
   - Обновляется клавиатура на "Поехали", "Отменить"
   - Клиент получает уведомление

3. **Водитель нажимает "Поехали":**
   - Проверяется: заказ существует, права доступа, статус = `arrived`
   - Если уже `onboard` → просто OK (идемпотентность)
   - Обновляется клавиатура на "Завершить поездку"
   - Клиент получает уведомление

4. **Водитель нажимает "Завершить поездку":**
   - Проверяется: заказ существует, права доступа, статус = `onboard`
   - Если уже `finished` → просто OK (идемпотентность)
   - Водитель возвращается в очередь
   - Клиент получает запрос оценки

5. **Водитель нажимает "Я на линии":**
   - Проверяется активный заказ через `get_active_driver_order()`
   - Если есть → показывается с актуальными кнопками
   - Если нет → показывается выбор зоны

6. **Водитель нажимает старую кнопку:**
   - Хэндлер парсит `order_id` из callback
   - Проверяет валидацию
   - Если заказ закрыт → показывает мягкое сообщение с предложением `/my_orders`

## Файлы изменены

- `bot/utils/keyboards.py` - новый формат callback
- `bot/handlers/driver_trip.py` - валидация и идемпотентность
- `bot/services/order_service.py` - идемпотентные переходы
- `bot/handlers/driver_queue.py` - новое сообщение при принятии, проверка активного заказа
- `bot/handlers/driver.py` - обновлена функция `driver_orders`, добавлена команда `/my_orders`

## Тестирование

1. Примите заказ → должно появиться новое сообщение с кнопками
2. Нажмите "Подъехал" → должно обновиться на "Поехали"
3. Перезапустите бота → нажмите "Я на линии" → должен показаться активный заказ
4. Нажмите старую кнопку из закрытого заказа → должно показаться мягкое сообщение
5. Нажмите "Подъехал" дважды → второй раз должен просто вернуть OK (идемпотентность)

